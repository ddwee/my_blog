---
import { getArchiveData } from '../utils/articles';

const archiveData = await getArchiveData();
const years = Object.keys(archiveData).sort((a, b) => b.localeCompare(a));
---

<aside class="sidebar">
  <h3>アーカイブ</h3>
  <select class="archive-select" id="yearSelect">
    <option value="">年を選択</option>
    {years.map(year => {
      const totalCount = Object.values(archiveData[year]).reduce((a, b) => a + b, 0);
      return <option value={year}>{year}年 ({totalCount}件)</option>
    })}
  </select>
  <ul class="archive-list" id="archiveList"></ul>
</aside>

<script define:vars={{ archiveData }}>
  function initArchive() {
    const yearSelect = document.getElementById('yearSelect');
    const archiveList = document.getElementById('archiveList');

    if (!yearSelect || !archiveList) return;

    const newYearSelect = yearSelect.cloneNode(true);
    yearSelect.parentNode.replaceChild(newYearSelect, yearSelect);

    newYearSelect.addEventListener('change', (e) => {
      const selectedYear = e.target.value;
      
      if (!selectedYear) {
        archiveList.innerHTML = '';
        return;
      }

      const months = archiveData[selectedYear];
      const sortedMonths = Object.keys(months).sort((a, b) => b.localeCompare(a));
      
      archiveList.innerHTML = sortedMonths.map(month => {
        const archiveLink = `/archive/${selectedYear}${month}/page/1`;
        
        return `
          <li>
            <a href="${archiveLink}">
              <span>${parseInt(month)}月</span>
              <span class="count">(${months[month]}件)</span>
            </a>
          </li>
        `;
      }).join('');
    });
  }

  initArchive();
  document.addEventListener('astro:page-load', initArchive);
</script>