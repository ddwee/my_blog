---
import Layout from '../../../layouts/Layout.astro';
import Header from '../../../components/Header.astro';
import Sidebar from '../../../components/Sidebar.astro';
import ArticleCard from '../../../components/ArticleCard.astro';
import Pagination from '../../../components/Pagination.astro';
import fs from 'fs/promises';
import path from 'path';

export async function getStaticPaths() {
  const listPath = path.join(process.cwd(), 'public/articles/list.json');
  const listData = await fs.readFile(listPath, 'utf-8');
  const articleIds: string[] = JSON.parse(listData);
  
  // 全記事を読み込んでタグごとにグループ化
  const articles = await Promise.all(
    articleIds.map(async (id) => {
      const articlePath = path.join(process.cwd(), `public/articles/${id}.json`);
      const articleData = await fs.readFile(articlePath, 'utf-8');
      return JSON.parse(articleData);
    })
  );
  
  const tagMap = new Map<string, any[]>();
  articles.forEach(article => {
    if (article.tags) {
      article.tags.forEach((tag: string) => {
        if (!tagMap.has(tag)) {
          tagMap.set(tag, []);
        }
        tagMap.get(tag)!.push(article);
      });
    }
  });
  
  const articlesPerPage = 4;
  const paths: any[] = [];
  
  // 各タグのページを生成
  tagMap.forEach((articles, tag) => {
    const totalPages = Math.ceil(articles.length / articlesPerPage);
    for (let i = 1; i <= totalPages; i++) {
      paths.push({
        params: { tag, page: String(i) },
      });
    }
  });
  
  return paths;
}

const { tag, page } = Astro.params;
const currentPage = parseInt(page);

// 記事一覧を取得
const listPath = path.join(process.cwd(), 'public/articles/list.json');
const listData = await fs.readFile(listPath, 'utf-8');
const articleIds: string[] = JSON.parse(listData);

// 全記事を読み込む
const allArticles = await Promise.all(
  articleIds.map(async (id) => {
    const articlePath = path.join(process.cwd(), `public/articles/${id}.json`);
    const articleData = await fs.readFile(articlePath, 'utf-8');
    return JSON.parse(articleData);
  })
);

// 該当タグの記事をフィルタ
const filteredArticles = allArticles.filter(article => 
  article.tags && article.tags.includes(tag)
);

// ページネーション
const articlesPerPage = 4;
const start = (currentPage - 1) * articlesPerPage;
const end = start + articlesPerPage;
const articlesToShow = filteredArticles.slice(start, end);

const totalPages = Math.ceil(filteredArticles.length / articlesPerPage);
---

<Layout title={`タグ: ${tag} - 私の日記`}>
  <Header />
  
  <div class="container">
    <Sidebar />
    
    <div class="main-content">
      <div id="filterInfo">
        <div class="filter-info">
          <strong>タグ: {tag}</strong> の記事
          <a href="/" class="clear-filter">フィルタをクリア</a>
        </div>
      </div>
      
      <main id="content">
        {articlesToShow.map(article => (
          <ArticleCard article={article} filterType="tag" filterValue={tag} />
        ))}
      </main>
      
      {totalPages > 1 && (
        <Pagination 
          currentPage={currentPage}
          totalPages={totalPages}
          baseUrl={`/tag/${tag}/page/`}
        />
      )}
    </div>
  </div>
</Layout>