---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Sidebar from '../../components/Sidebar.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import Pagination from '../../components/Pagination.astro';

export async function getStaticPaths() {
  const listResponse = await fetch(new URL('/articles/list.json', 'http://localhost:4321'));
  const articleIds: string[] = await listResponse.json();
  
  // 全記事を読み込んでカテゴリを収集
  const articles = await Promise.all(
    articleIds.map(async (id) => {
      const res = await fetch(new URL(`/articles/${id}.json`, 'http://localhost:4321'));
      return await res.json();
    })
  );
  
  // カテゴリのリストを作成
  const categories = new Set<string>();
  articles.forEach(article => {
    if (article.category) {
      categories.add(article.category);
    }
  });
  
  return Array.from(categories).map(category => ({
    params: { category },
  }));
}

const { category } = Astro.params;

// 記事一覧を取得
const listResponse = await fetch(new URL('/articles/list.json', Astro.site || 'http://localhost:4321'));
const articleIds: string[] = await listResponse.json();

// 全記事を読み込む
const allArticles = await Promise.all(
  articleIds.map(async (id) => {
    const res = await fetch(new URL(`/articles/${id}.json`, Astro.site || 'http://localhost:4321'));
    return await res.json();
  })
);

// 該当カテゴリの記事をフィルタ
const filteredArticles = allArticles.filter(article => article.category === category);

// ページネーション
const articlesPerPage = 4;
const currentPage = 1;
const start = 0;
const end = articlesPerPage;
const articlesToShow = filteredArticles.slice(start, end);

const totalPages = Math.ceil(filteredArticles.length / articlesPerPage);
---

<Layout title={`カテゴリ: ${category} - 私の日記`}>
  <Header />
  
  <div class="container">
    <Sidebar />
    
    <div class="main-content">
      <div id="filterInfo">
        <div class="filter-info">
          <strong>カテゴリ: {category}</strong> の記事
          <a href="/" class="clear-filter">フィルタをクリア</a>
        </div>
      </div>
      
      <main id="content">
        {articlesToShow.map(article => (
          <ArticleCard article={article} filterType="category" filterValue={category} />
        ))}
      </main>
      
      {totalPages > 1 && (
        <Pagination 
          currentPage={currentPage}
          totalPages={totalPages}
          baseUrl={`/category/${category}/page/`}
        />
      )}
    </div>
  </div>
</Layout>