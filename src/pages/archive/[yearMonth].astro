---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Sidebar from '../../components/Sidebar.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import Pagination from '../../components/Pagination.astro';
import fs from 'fs/promises';
import path from 'path';

export async function getStaticPaths() {
  const listPath = path.join(process.cwd(), 'public/articles/list.json');
  const listData = await fs.readFile(listPath, 'utf-8');
  const articleIds: string[] = JSON.parse(listData);
  
  // 年月のリストを作成
  const yearMonths = new Set<string>();
  articleIds.forEach(id => {
    const yearMonth = id.substring(0, 6);
    yearMonths.add(yearMonth);
  });
  
  return Array.from(yearMonths).map(yearMonth => ({
    params: { yearMonth },
  }));
}

const { yearMonth } = Astro.params;

// 記事一覧を取得
const listPath = path.join(process.cwd(), 'public/articles/list.json');
const listData = await fs.readFile(listPath, 'utf-8');
const articleIds: string[] = JSON.parse(listData);

// 該当する年月の記事をフィルタ
const filteredIds = articleIds.filter(id => id.startsWith(yearMonth));

// 記事を読み込む
const articlesPerPage = 4;
const currentPage = 1;
const start = 0;
const end = articlesPerPage;
const idsToShow = filteredIds.slice(start, end);

const articles = await Promise.all(
  idsToShow.map(async (id) => {
    const articlePath = path.join(process.cwd(), `public/articles/${id}.json`);
    const articleData = await fs.readFile(articlePath, 'utf-8');
    return JSON.parse(articleData);
  })
);

const totalPages = Math.ceil(filteredIds.length / articlesPerPage);

// 年月を表示用にフォーマット
const year = yearMonth.substring(0, 4);
const month = parseInt(yearMonth.substring(4, 6));
---