---
import Layout from '../../../../layouts/Layout.astro';
import Header from '../../../../components/Header.astro';
import Sidebar from '../../../../components/Sidebar.astro';
import ArticleCard from '../../../../components/ArticleCard.astro';
import Pagination from '../../../../components/Pagination.astro';
import { getYearMonths, getPostsByYearMonth } from '../../../../utils/articles';

export async function getStaticPaths() {
  const yearMonths = await getYearMonths();
  const articlesPerPage = 4;
  const paths: any[] = [];
  
  for (const yearMonth of yearMonths) {
    const posts = await getPostsByYearMonth(yearMonth);
    const totalPages = Math.ceil(posts.length / articlesPerPage);
    
    for (let i = 1; i <= totalPages; i++) {
      paths.push({
        params: { yearMonth, page: String(i) },
      });
    }
  }
  
  return paths;
}

const { yearMonth, page } = Astro.params;
const currentPage = parseInt(page);

const allPosts = await getPostsByYearMonth(yearMonth);

const articlesPerPage = 4;
const start = (currentPage - 1) * articlesPerPage;
const end = start + articlesPerPage;
const posts = allPosts.slice(start, end);

const totalPages = Math.ceil(allPosts.length / articlesPerPage);

// 年月を表示用にフォーマット
const year = yearMonth.substring(0, 4);
const month = parseInt(yearMonth.substring(4, 6));
---

<Layout title={`${year}年${month}月のアーカイブ - 私の日記`}>
  <Header />
  
  <div class="container">
    <Sidebar />
    
    <div class="main-content">
      <div id="filterInfo">
        <div class="filter-info">
          <strong>{year}年{month}月</strong> の記事
          <a href="/" class="clear-filter">フィルタをクリア</a>
        </div>
      </div>
      
      <main id="content">
        {posts.map(post => (
          <ArticleCard post={post} filterType="archive" filterValue={yearMonth} />
        ))}
      </main>
      
      {totalPages > 1 && (
        <Pagination 
          currentPage={currentPage}
          totalPages={totalPages}
          baseUrl={`/archive/${yearMonth}/page/`}
        />
      )}
    </div>
  </div>
</Layout>