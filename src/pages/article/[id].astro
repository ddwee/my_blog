---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Sidebar from '../../components/Sidebar.astro';
import { getPostIds, getPostById } from '../../utils/articles';

export async function getStaticPaths() {
  const postIds = await getPostIds();
  return postIds.map(id => ({
    params: { id },
  }));
}

const { id } = Astro.params;

const entry = await getPostById(id);
if (!entry) {
  return Astro.redirect('/404');
}

const { Content } = await entry.render();

const allPostIds = await getPostIds();
const currentIndex = allPostIds.indexOf(id);
const nextId = currentIndex > 0 ? allPostIds[currentIndex - 1] : null;
const prevId = currentIndex < allPostIds.length - 1 ? allPostIds[currentIndex + 1] : null;

let nextPost = null;
let prevPost = null;

if (nextId) {
  nextPost = await getPostById(nextId);
}

if (prevId) {
  prevPost = await getPostById(prevId);
}
---

<Layout title={`${entry.data.title} - 私の日記`}>
  <Header />
  
  <div class="container">
    <Sidebar />
    
    <div class="main-content">
      <main>
        <article>
          <div class="date">{entry.data.date}</div>
          <h2>{entry.data.title}</h2>
          <div class="meta">
            <a href={`/category/${entry.data.category}`} class="category">{entry.data.category}</a>
            {entry.data.tags && (
              <div class="tags">
                {entry.data.tags.map((tag: string) => (
                  <a href={`/tag/${tag}`} class="tag">#{tag}</a>
                ))}
              </div>
            )}
          </div>
          <div class="article-content">
            <Content />
          </div>
        </article>

        <nav class="article-nav">
          {prevPost ? (
            <a href={`/article/${prevId}`} class="article-nav-item prev">
              <span class="nav-label">← 過去の記事</span>
              <span class="nav-title">{prevPost.data.title}</span>
            </a>
          ) : (
            <div class="article-nav-item-spacer"></div>
          )}
          
          <a href="/" class="home-button" id="homeButton" title="記事一覧に戻る">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
          </a>

          {nextPost ? (
            <a href={`/article/${nextId}`} class="article-nav-item next">
              <span class="nav-label">新しい記事 →</span>
              <span class="nav-title">{nextPost.data.title}</span>
            </a>
          ) : (
            <div class="article-nav-item-spacer"></div>
          )}
        </nav>
      </main>
    </div>
  </div>
</Layout>

<script>
  function initHomeButton() {
    const homeButton = document.getElementById('homeButton');
    if (!homeButton) return;

    const currentPath = window.location.pathname;
    if (currentPath.startsWith('/article/')) {
      const returnUrl = sessionStorage.getItem('returnUrl');
      if (returnUrl && !returnUrl.startsWith('/article/')) {
        homeButton.setAttribute('href', returnUrl);
      } else {
        homeButton.setAttribute('href', '/');
      }
    }
  }

  initHomeButton();
  document.addEventListener('astro:page-load', initHomeButton);
</script>